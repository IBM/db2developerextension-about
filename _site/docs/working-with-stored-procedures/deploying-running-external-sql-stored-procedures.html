<h1 id="deploying-and-running-external-sql-stored-procedures">Deploying and running external SQL stored procedures</h1>

<p>This article shows you how to use Db2 Developer Extension to deploy an external SQL stored procedure with various deployment options: altering previous deployments, setting target schema, and others. It also walks you through the process of running an external SQL stored procedure.</p>

<p><strong>Tip:</strong> If you’re new to stored procedures, make sure you’re familiar with the information in <a href="/Aparna-Ashokan/Db2-developer-extension-staging/docs/working-with-stored-procedures/creating-external-sql-stored-procedures.html">Creating external SQL stored procedures</a> first.</p>

<p>One big advantage of using Db2 Developer Extension to deploy a stored procedure, as opposed to manually executing SQL, is that you can save the various deployment options separately from the SQL itself, which means that you can push your code into a source code manager, such as GitHub, without having to remove the deployment debug options first.</p>

<p>Another advantage is that you don’t need to specify <code class="language-plaintext highlighter-rouge">--#SET TERMINATOR</code> in the header of <strong>.spsql</strong> files. Db2 Developer Extension uses the number sign character (#) as the default terminator character, but you can use any terminator character you want by setting a SQL routine option (explained later in this article).</p>

<p><strong>Note:</strong> Currently, Db2 Developer Extension deploy and run options support only one stored procedure per <strong>.spsql</strong> file. When stored procedure options are specified, only the first stored procedure in the file will be executed; additional stored procedures and SQL statements will be ignored.</p>

<p>We’ll use the following example external SQL stored procedure throughout this article to demonstrate how to deploy and run an external SQL stored procedure. This stored procedure will read the total salary, including bonuses, from the table <code class="language-plaintext highlighter-rouge">DSN8D10.EMP</code> from a passed in-parameter <code class="language-plaintext highlighter-rouge">DEPTNUMBER</code>. You can paste it into a file so that you try things out for yourself.</p>

<p><strong>RETURNDEPTSALARY.spsql</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CREATE PROCEDURE ADMF001.RETURNDEPTSALARY
 (IN DEPTNUMBER CHAR(3),
  OUT DEPTSALARY DECIMAL(15,2),
  OUT DEPTBONUSCNT INT)
 LANGUAGE SQL
 READS SQL DATA
 EXTERNAL NAME 'RSALARY'
 FENCED
 P1: BEGIN
     DECLARE EMPLOYEE_SALARY DECIMAL(9,2);
     DECLARE EMPLOYEE_BONUS DECIMAL(9,2);
     DECLARE TOTAL_SALARY DECIMAL(15,2) DEFAULT 0;
     DECLARE BONUS_CNT INT DEFAULT 0;
     DECLARE END_TABLE INT DEFAULT 0;
     DECLARE C1 CURSOR FOR
      SELECT SALARY, BONUS FROM DSN8D10.EMP
       WHERE WORKDEPT = DEPTNUMBER;
     DECLARE CONTINUE HANDLER FOR NOT FOUND
      SET END_TABLE = 1;
     DECLARE EXIT HANDLER FOR SQLEXCEPTION
      SET DEPTSALARY = NULL;
     OPEN C1;
     FETCH C1 INTO EMPLOYEE_SALARY, EMPLOYEE_BONUS;
     WHILE END_TABLE = 0 DO
      SET TOTAL_SALARY = TOTAL_SALARY + EMPLOYEE_SALARY + EMPLOYEE_BONUS;
      IF EMPLOYEE_BONUS &gt; 0 THEN
       SET BONUS_CNT = BONUS_CNT + 1;
      END IF;
      FETCH C1 INTO EMPLOYEE_SALARY, EMPLOYEE_BONUS;
     END WHILE;
     CLOSE C1;
     SET DEPTSALARY = TOTAL_SALARY;
     SET DEPTBONUSCNT = BONUS_CNT;
 END P1
</code></pre></div></div>

<p>The file extension of <code class="language-plaintext highlighter-rouge">.spsql</code> identifies it as a stored procedure, and the <code class="language-plaintext highlighter-rouge">EXTERNAL NAME</code> and <code class="language-plaintext highlighter-rouge">FENCED</code> claues identify it as an external SQL stored procedure. When you open a <strong>.spsql</strong> file in Db2 Developer Extension, you get some additional actions in the toolbar in the upper right corner of the view:</p>

<p>From left to right, these actions are <strong>Deploy</strong>, <strong>Debug</strong>, and <strong>Run</strong>. We’ll cover each one in the following sections.</p>

<p><img src="/Aparna-Ashokan/Db2-developer-extension-staging/assets/images/nsp-basics-action-toolbar.png" alt="Deploy, Debug, Run, action icons" /></p>

<h2 id="deploying-a-stored-procedure">Deploying a stored procedure</h2>

<p>You can deploy a stored procedure by using any of the following methods:</p>

<ul>
  <li>From within the <strong>.spsql</strong> file by clicking <strong>Deploy stored procedure</strong> from the context menu or the <strong>Deployment</strong> icon</li>
  <li>From within the catalog navigation view by clicking <strong>Deploy</strong> from the overflow menu</li>
</ul>

<p>The <strong>Deployment</strong> view is where you can set and customize deployment options and save the options for the <strong>.spsql</strong> file. These options are used only during deployment and do not impact the DDL source code.</p>

<p>The <strong>Deployment</strong> view consists of three sections: <strong>Deployment options</strong>, <strong>Routine options</strong>, and <strong>External options</strong>.</p>

<h3 id="deployment-options">Deployment options</h3>

<p><img src="/Aparna-Ashokan/Db2-developer-extension-staging/assets/images/esp-deployment-options.png" alt="Deployment options" /></p>

<ul>
  <li>
    <p>Use the <strong>Database connection</strong> option to select a connection from the list of defined connections. See <a href="/Aparna-Ashokan/Db2-developer-extension-staging/docs/the-basics/creating-a-database-connection.html">Creating a database connection</a> for more information.</p>
  </li>
  <li>
    <p>Use the <strong>Target schema</strong> option for unqualified stored procedures. This field is enabled only for unqualified stored procedures. If the stored procedure is qualified (lsuch as the one in our example CREATE PROCEDURE statement, which is qualified to ADMF001), the field is disabled. If you leave this field empty, the JDBC property <code class="language-plaintext highlighter-rouge">currentSchema</code> will be used. If <code class="language-plaintext highlighter-rouge">currentSchema</code> is not set, the JDBC connection username will be used.</p>
  </li>
  <li>
    <p>Use the <strong>Build owner</strong> option to specify the owner of the stored procedure. If this field is left empty, the JDBC property <code class="language-plaintext highlighter-rouge">currentSQLID</code> will be used. If <code class="language-plaintext highlighter-rouge">currentSQLID</code> is not set, the JDBC connection username will be used.</p>
  </li>
  <li>
    <p>Use the <strong>Default path</strong> option for resolving an unqualified data type, function, or procedure referenced by the procedure that’s being deployed. You can specify multiple schemas, each one separated by a comma. For example:</p>
  </li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    "ADMF002","ADMF003","ADMF004"
</code></pre></div></div>

<ul>
  <li>
    <p>Use the <strong>Duplicate handling</strong> option to specify the behavior of the deployment if the procedure already exists:</p>

    <ul>
      <li>
        <p><strong>Drop duplicates</strong> calls DROP PROCEDURE before running the CREATE PROCEDURE DDL if the procedure already exists and creates the procedure.</p>
      </li>
      <li>
        <p><strong>Treat duplicate deployments as errors</strong> returns an error if the procedure already exists. If other versions of the procedure do not already exist, the procedure is created.</p>
      </li>
    </ul>
  </li>
</ul>

<p><strong>Note:</strong> Not all options mentioned above are displayed due to screen size limit.</p>

<p>If you’re new to SQL and want more information about embedding SQL in host languages, there’s a lot of information about this topic in the <a href="https://www.ibm.com/support/knowledgecenter/en/SSEPEK_13.0.0/apsg/src/tpc/db2z_programembeddedsql.html">Db2 for z/OS documentation</a>.</p>

<h3 id="routine-options">Routine options</h3>

<p><img src="/Aparna-Ashokan/Db2-developer-extension-staging/assets/images/esp-routine-options.png" alt="Routine options" /></p>

<ul>
  <li>
    <p>Use the <strong>Enable debugging option</strong> to specify whether this procedure is available to be debugged.</p>
  </li>
  <li>
    <p>Use the <strong>WLM environment</strong> option to specify which Workload Manager environment will be used to debug the procedure. If you enable debugging but leave this field empty, the default WLM environment will used.</p>
  </li>
  <li>
    <p>Use the <strong>ASU time limit</strong> option to set the ASUTIME, which is the number of CPU seconds permitted for each SQL statement. The default value of 0 means NO LIMIT and is not recommended.</p>
  </li>
  <li>
    <p>Use the <strong>Additional routine options</strong> field to specify any additional options that you want to include. Separate each option with a semicolon. For example:</p>
  </li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   QUALIFIER ADMF002; ISOLATION LEVEL RS
</code></pre></div></div>

<h3 id="external-options">External options</h3>

<p><img src="/Aparna-Ashokan/Db2-developer-extension-staging/assets/images/esp-sql-options.png" alt="External SQL options" /></p>

<ul>
  <li>
    <p>The <strong>Build utility</strong> field identifies the Db2 SQL procedure processor, <a href="https://www.ibm.com/docs/en/db2-for-zos/13?topic=deprecated-creating-external-sql-procedure-by-using-dsntpsmp">SYSPROC.DSNTPSMP</a>, which is used to create an external SQL stored procedure.</p>
  </li>
  <li>
    <p>Use the <strong>Precompile options</strong> option to specify options for precompiling the C language program that Db2 generates for the external SQL procedure. Do not specify the HOST option. For a list of these options see <a href="https://www.ibm.com/docs/en/db2-for-zos/13?topic=processing-descriptions-sql-options">SQL processing options</a>.</p>
  </li>
  <li>
    <p>Use the <strong>Compile options</strong> option to specify options for compiling the C language program that Db2 generates for the external SQL procedure.</p>
  </li>
  <li>
    <p>Use the <strong>Prelink options</strong> option to specify options for prelinking the C language program that Db2 generates for the external SQL procedure.</p>
  </li>
  <li>
    <p>Use the <strong>Link options</strong> option to specify options for linking the C language program that Db2 generates for the external SQL procedure.</p>
  </li>
  <li>
    <p>Use the <strong>Bind options</strong> option to specify options for binding the external SQL procedure package. Do not specify the MEMBER or LIBRARY option for the Db2 BIND PACKAGE command. For a list of these options, see <a href="https://www.ibm.com/docs/en/db2-for-zos/13?topic=commands-bind-rebind-options-packages-plans-services">BIND and REBIND options</a>.</p>
  </li>
</ul>

<p>Click <strong>Deploy</strong> to finish the configuration and begin the deployment process for the procedure.</p>

<h2 id="running-a-stored-procedure">Running a stored procedure</h2>

<p>You can run a stored procedure by using any of the following methods:</p>

<ul>
  <li>From within the catalog navigation view by clicking <strong>Run</strong> from the overflow menu</li>
  <li>From within a <strong>.spsql</strong> file by clicking <strong>Run stored procedure</strong> from the context menu or the <strong>Run stored procedure</strong> icon</li>
  <li>From the SQL editor either by clicking <strong>Run All</strong> or highlighting part of the file and clicking <strong>Run Selected SQL</strong></li>
</ul>

<p>If your stored procedure contains input variables, you’ll be prompted to specify values for them before the stored procedure executes, as shown in the following figure. Note that built-in data types for each input variable are detected automatically and are set to the correct data type.</p>

<p>If you have an input type that’s an array, you’d specify the values like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>numeric:   [1; 2; 3]
character: [hello; world]
</code></pre></div></div>

<p><strong>Note</strong>: Arrays are not supported when you run a stored procedure from the SQL editor.</p>

<p>If your statement contains host variables or positional parameters, you’ll be prompted to specify values for input variables and parameters.</p>

<p><img src="/Aparna-Ashokan/Db2-developer-extension-staging/assets/images/nsp-basics-run-parameters.png" alt="Input parameters for running" /></p>

<p>After your stored procedure is executed, the following output is displayed in these tabs:</p>

<ul>
  <li>The <strong>Status</strong> tab contains overall execution status. If an error occurred, the status will contain <strong>SQL code</strong>, <strong>SQL state</strong>, and <strong>Message text</strong>.</li>
</ul>

<p><img src="/Aparna-Ashokan/Db2-developer-extension-staging/assets/images/nsp-basics-status-tab.png" alt="Status tab" /></p>

<ul>
  <li>The <strong>Parameters</strong> tab contains variable information for passed-in parameters.</li>
</ul>

<p><img src="/Aparna-Ashokan/Db2-developer-extension-staging/assets/images/nsp-basics-parameters-tab.png" alt="Parameters tab" /></p>

<ul>
  <li>The <strong>SQL Results</strong> view contains data if a result set is expected (in our example, a result set isn’t expected so the <strong>Result</strong> tab isn’t shown).</li>
</ul>

<!--
## Specifying additional options

You can specify and save additional run options by right-clicking inside the editor and selecting **Run SQL Options**.

![Run SQL Options](/Aparna-Ashokan/Db2-developer-extension-staging/assets/images/esp-run-sql-options.png)

...which opens the **JDBC runtime options** view:

![JDBC runtime options](/Aparna-Ashokan/Db2-developer-extension-staging/assets/images/nsp-basics-jdbc-runtime-options.png)

This article covers only the following options that you can set in this view:

- Use the **Statement terminator character** option to set the statement terminator for the file.

- Use the **Current schema** option for resolving regular object types such as tables, views, and indexes.

- Use the **Current path** option for resolving an unqualified data type, function, or procedure referenced by the procedure that is being deployed.  You can specify multiple schemas by separating each one with a comma. For example:

```
    "ADMF002","ADMF003","ADMF004"
```

**About commit and rollback options:** The commit and rollback options behave a little differently with stored procedures. First, by default, all stored procedures run with COMMIT ON RETURN NO. You can change this behavior by including the COMMIT ON RETURN YES clause in your stored procedure DDL. If you need more control over the SQL statements in a stored procedure at the unit of work level, see [COMMIT and ROLLBACK statements in a stored procedure](https://www.ibm.com/support/knowledgecenter/SSEPEK_13.0.0/apsg/src/tpc/db2z_commitrollbacksp.html).

Second, Db2 Developer Extension runs only the first stored procedure in a file and ignores any other SQL statements that you might have selected to run. If you select **Commit on completion** or **Rollback changes on completion**, processing will end after the first stored procedure is processed, even if you intended to run additional SQL statements in that same file. See [Committing and rolling back changes](/Aparna-Ashokan/Db2-developer-extension-staging/docs/the-basics/committing-and-rolling-back-changes.html) for more information.
-->
