<h1 id="deploying-and-running-user-defined-functions">Deploying and running user-defined functions</h1>

<p>This article shows you how to use Db2 Developer Extension to deploy an SQL user-defined function (UDF) with various deployment options: altering previous deployments, setting target schema, and others. It also walks you through the process of running a UDF.</p>

<p>One big advantage of using Db2 Developer Extension to deploy a UDF, as opposed to manually executing SQL, is that you can save the various deployment options separately from the SQL itself, which means that you can push your code into a source code manager, such as GitHub, without having to remove your personal deployment options first.</p>

<p>Another advantage is that you don’t need to specify <code class="language-plaintext highlighter-rouge">--#SET TERMINATOR</code> in the header of <strong>.udfsql</strong> files. Db2 Developer Extension uses the number sign character (#) as the default terminator character, but you can use any terminator character you want by setting an SQL routine option.</p>

<p><strong>Note:</strong> Currently, Db2 Developer Extension deployment option supports only one UDF per <strong>.udfsql</strong> file. When UDF options are specified, only the first UDF in the file will be executed; additional UDFs and SQL statements will be ignored.</p>

<p>We’ll use the following SQL user-defined function throughout this article to demonstrate how to deploy a UDF. This UDF takes in a string as input and returns the text in reverse order. You can paste it into a file so that you try things out for yourself.</p>

<p><strong>REVERSE.udfsql</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CREATE FUNCTION ADMF001.REVERSE(INSTR VARCHAR(4000))
    RETURNS VARCHAR(4000)
    VERSION V1
    DETERMINISTIC NO EXTERNAL ACTION CONTAINS SQL
    BEGIN
    DECLARE REVSTR, RESTSTR VARCHAR(4000) DEFAULT '';
    DECLARE LEN INT;
    IF INSTR IS NULL THEN
    RETURN NULL;
    END IF;
    SET (RESTSTR, LEN) = (INSTR, LENGTH(INSTR));
    WHILE LEN &gt; 0 DO
    SET (REVSTR, RESTSTR, LEN) 
        = (SUBSTR(RESTSTR, 1, 1) CONCAT REVSTR, 
        SUBSTR(RESTSTR, 2, LEN - 1),
        LEN - 1);
    END WHILE;
    RETURN REVSTR;
END
</code></pre></div></div>

<p>Here’s how that same SQL user-defined function looks in Db2 Developer Extension:</p>

<p><img src="/Aparna-Ashokan/Db2-developer-extension-staging/assets/images/udfsql-deploy-example.png" alt="Example of SQL UDF" /></p>

<p>The file extension of <code class="language-plaintext highlighter-rouge">.udfsql</code> identifies it as an SQL user-defined function. When you open a <strong>.udfsql</strong> file in Db2 Developer Extension, you get some additional actions in the toolbar in the upper right corner of the view:</p>

<p><img src="/Aparna-Ashokan/Db2-developer-extension-staging/assets/images/nsp-basics-action-toolbar.png" alt="Deploy, Debug, Run, action icons" /></p>

<p>From left to right, these actions are <strong>Deploy</strong>, <strong>Debug</strong>, and <strong>Run</strong>. We’ll cover deploying and running in the following sections.</p>

<h2 id="deploying-a-user-defined-function">Deploying a user-defined function</h2>

<p>You can deploy a user-defined function by using any of the following methods:</p>

<ul>
  <li>From within the <strong>.udfsql</strong> file by clicking <strong>Deploy user-defined function</strong> from the context menu or the <strong>Deployment</strong> icon</li>
  <li>From within the catalog navigation view by clicking <strong>Deploy</strong> from the overflow menu</li>
</ul>

<p>The <strong>Deployment</strong> view is where you can set and customize deployment options and save the options for the <strong>.udfsql</strong> file. These options are used only during deployment and do not impact the DDL source code.</p>

<p>The <strong>Deployment</strong> view consists of two sections: <strong>Deployment options</strong> and <strong>Routine options</strong>.</p>

<h3 id="deployment-options">Deployment options</h3>

<p><img src="/Aparna-Ashokan/Db2-developer-extension-staging/assets/images/udf-deployment-options.png" alt="Deployment options" /></p>

<ul>
  <li>
    <p>Use the <strong>Database connection</strong> option to select a connection from the list of defined connections. See <a href="/Aparna-Ashokan/Db2-developer-extension-staging/docs/the-basics/creating-a-database-connection.html">Creating a database connection</a> for more information.</p>
  </li>
  <li>
    <p>Use the <strong>Target schema</strong> option for unqualified UDFs. This field is enabled only for unqualified UDFs. If the UDF is qualified (like the one in our example CREATE FUNCTION statement, which is qualified to ADMF001), the field is disabled. If you leave this field empty, the JDBC property <code class="language-plaintext highlighter-rouge">currentSchema</code> will be used. If <code class="language-plaintext highlighter-rouge">currentSchema</code> is not set, the JDBC connection username will be used.</p>
  </li>
  <li>
    <p>Use the <strong>Build owner</strong> option to specify the owner of the UDF. If this field is left empty, the JDBC property <code class="language-plaintext highlighter-rouge">currentSQLID</code> will be used. If <code class="language-plaintext highlighter-rouge">currentSQLID</code> is not set, the JDBC connection username will be used.</p>
  </li>
  <li>
    <p>Use the <strong>Default path</strong> option for resolving an unqualified data type, function, or procedure referenced by the UDF that’s being deployed. You can specify multiple schemas, each one separated by a comma. For example:</p>
  </li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    "ADMF002","ADMF003","ADMF004"
</code></pre></div></div>

<ul>
  <li>
    <p>Use the <strong>Duplicate handling</strong> option to specify the behavior of the deployment if the UDF already exists:</p>

    <ul>
      <li>
        <p><strong>Alter duplicates</strong> modifies the CREATE FUNCTION DDL to ALTER FUNCTION if the UDF already exists. Optionally, you can choose not to activate the UDF upon deployment; otherwise, it’s activated by default. If <code class="language-plaintext highlighter-rouge">VERSION</code> is not specified in the DDL, the <strong>Alter duplicates</strong> option is not displayed.</p>
      </li>
      <li>
        <p><strong>Drop duplicates</strong> calls DROP FUNCTION before running the CREATE FUNCTION if the UDF already exists, creates the UDF, and activates it upon deployment. By default, Db2 activates the first version of a UDF.</p>
      </li>
      <li>
        <p><strong>Treat duplicate deployments as errors</strong> returns an error if the UDF already exists.</p>
      </li>
    </ul>
  </li>
</ul>

<h3 id="routine-options">Routine options</h3>

<p><img src="/Aparna-Ashokan/Db2-developer-extension-staging/assets/images/udf-routine-options.png" alt="Routine options" /></p>

<ul>
  <li>
    <p>Use the <strong>Enable debugging</strong> option to specify whether this UDF is available to be debugged.</p>
  </li>
  <li>
    <p>Use the <strong>WLM environment</strong> option to specify which Workload Manager environment will be used to debug the UDF. If you enable debugging but leave this field empty, the default WLM environment will used.</p>
  </li>
  <li>
    <p>Use the <strong>ASU time limit</strong> option to set the ASUTIME, which is the number of CPU seconds permitted for each SQL statement. The default value of 0 means NO LIMIT and is not recommended.</p>
  </li>
  <li>
    <p>Use the <strong>Additional routine options</strong> field to specify any additional options that you want to include. Separate each option with a semicolon. For example:</p>
  </li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   QUALIFIER ADMF002; ISOLATION LEVEL RS
</code></pre></div></div>

<p><strong>Note:</strong> The <strong>Routine options</strong> tab is only available for compiled SQL scalar functions.</p>

<p>Click <strong>Deploy</strong> to finish the configuration and begin the deployment process for the UDF.</p>

<p>After your SQL user-defined function is executed, the following output is displayed in the <strong>Status</strong> tab.</p>

<p><img src="/Aparna-Ashokan/Db2-developer-extension-staging/assets/images/udf-sql-results-window.png" alt="SQL results window" /></p>

<p>The <strong>Status</strong> tab contains overall execution status. If an error occurred, the status will contain SQL code, SQL state, and Message text.</p>

<h2 id="running-a-user-defined-function">Running a user-defined function</h2>

<p>You can run a UDF by using any of the following methods:</p>

<ul>
  <li>From within the catalog navigation view by clicking <strong>Run</strong> from the overflow menu</li>
  <li>From within the <strong>.udfsql</strong> file by clicking <strong>Run User-Defined Function</strong> from the context menu or the <strong>Run User-Defined Function</strong> icon</li>
  <li>From within the SQL editor either by clicking <strong>Run All</strong> or by highlighting part of the file and clicking <strong>Run Selected SQL</strong></li>
</ul>

<p>If your UDF contains input variables, you’ll be prompted to specify values for them before the UDF executes, as shown in the following figure. Note that built-in data types for each input variable are detected automatically and are set to the correct data type.</p>

<p><img src="/Aparna-Ashokan/Db2-developer-extension-staging/assets/images/udf-run-parameters.png" alt="Input parameters for running a UDF" /></p>

<p>After your UDF runs, the following output is displayed in these tabs:</p>

<ul>
  <li>The <strong>Status</strong> tab contains the overall execution status. If an error occurred, the status will contain <strong>SQL code</strong>, <strong>SQL state</strong>, and <strong>Message text</strong>.</li>
</ul>

<p><img src="/Aparna-Ashokan/Db2-developer-extension-staging/assets/images/udf-run-status.png" alt="Status of running a UDF" /></p>

<ul>
  <li>The <strong>Results</strong> tab contains the output from running the UDF.</li>
</ul>

<p><img src="/Aparna-Ashokan/Db2-developer-extension-staging/assets/images/udf-run-results.png" alt="Results of running a UDF" /></p>

<p>Each time you run a UDF, the <strong>QUERY HISTORY</strong> view is updated with a record of that activity.</p>
