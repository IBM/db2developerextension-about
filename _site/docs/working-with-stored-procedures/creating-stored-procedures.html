<h1 id="creating-stored-procedures">Creating stored procedures</h1>

<p>This article covers the basics of using Db2 Developer Extension to create a simple stored procedure and then explains some of the more complex things you might need to do when you create a stored procedure, such as working with DBCS data and user-defined types.</p>

<p><a href="https://www.ibm.com/support/knowledgecenter/en/SSEPEK_13.0.0/apsg/src/tpc/db2z_storedprocedure.html">Stored procedures</a> are a powerful tool for increasing the performance and efficiency of distributed applications. Currently, Db2 Developer Extension supports Db2 for z/OS native stored procedures, which are stored procedures that are written entirely in SQL and are created by using the <a href="https://www.ibm.com/support/knowledgecenter/SSEPEK_13.0.0/sqlref/src/tpc/db2z_sql_createproceduresqlnative.html">CREATE PROCEDURE or CREATE  OR REPLACE PROCEDURE</a> statement, which is available with Db2 12 function level 507 and later.</p>

<h2 id="creating-a-basic-stored-procedure-with-code-snippets">Creating a basic stored procedure with code snippets</h2>

<ol>
  <li>
    <p>Open a new <strong>.spsql</strong> file, and start typing <code class="language-plaintext highlighter-rouge">CREATE PROCEDURE</code>. You’ll only need to type a few letters before you see CREATE PROCEDURE in the list of available code snippets.</p>
  </li>
  <li>
    <p>Select that snippet to populate your file with the basic CREATE PROCEDURE structure (in the following example, the procedure name has already been changed to MYPROCEDURE):</p>
  </li>
</ol>

<p><img src="/Aparna-Ashokan/Db2-developer-extension-staging/assets/images/nsp-basics-create-nsp.png" alt="CREATE PROCEDURE code snippet" /></p>

<p>The snippet includes some of the more commonly used parameters and an example SELECT statement. The SELECT statement is the part of the stored procedure that gets executed when the stored procedure is called. To see all of the options that you can define in a stored procedure, open the <a href="https://www.ibm.com/support/knowledgecenter/SSEPEK_13.0.0/sqlref/src/tpc/db2z_sql_createproceduresqlnative.html">link</a> that is included at the top of the snippet.</p>

<p>Now this stored procedure is ready to be deployed. To learn how, see <a href="/Aparna-Ashokan/Db2-developer-extension-staging/docs/working-with-stored-procedures/deploying-running-and-debugging-stored-procedures-basics.html">Deploying, running, and debugging stored procedures</a>.</p>

<p>Now let’s look at some more complex examples.</p>

<h2 id="working-with-double-byte-character-set-dbcs-data">Working with double-byte character set (DBCS) data</h2>

<p>Languages such as Chinese and Japanese contain double-byte characters, which are characters that are too large to represent with a single byte.  If you write SQL applications that support double-byte character languages, you need to know a bit about how Db2 for z/OS supports DBCS data and how character translation is handled.  This section describes how to code DBCS data in a Db2 for z/OS native stored procedure.</p>

<p>Db2 for z/OS provides DBCS support for the following data types:</p>

<ul>
  <li>
    <p><strong>GRAPHIC:</strong> A fixed-length data type that’s used to store a graphic string.</p>
  </li>
  <li>
    <p><strong>VARGRAPHIC:</strong> A varying-length data type used to store a variable-length graphic string.</p>
  </li>
  <li>
    <p><strong>CHAR or CLOB defined with “FOR MIXED DATA”:</strong> Data types that are used to store character data or mixed data (that is, a combination of single-byte character set (SBCS) characters and multi-byte character set (MBCS) characters).”</p>
  </li>
  <li>
    <p><strong>DBCLOB:</strong> A double-byte character large object.</p>
  </li>
</ul>

<p><strong>Tip:</strong> Db2 translates all Db2 character data between the internal Db2 table Code Character Set Identifier (CCSID) and the external application CCSID.</p>

<p>The following example shows a user-defined type stored procedure that includes a double-byte DBCLOB variable. When you create a stored procedure that includes DBCLOB parameters, you need to specify <code class="language-plaintext highlighter-rouge">PARAMETER CCSID UNICODE</code>, and if the stored procedure includes DBCLOBs in the body, you need to specify <code class="language-plaintext highlighter-rouge">APPLICATION ENCODING SCHEMA UNICODE</code>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CREATE PROCEDURE ADMF001.TEST_DBCLOB (
  IN VAR1 DBCLOB,
  INOUT VAR2 DBCLOB,
  OUT VAR3 DBCLOB
  )
  APPLICATION ENCODING SCHEME UNICODE
  PARAMETER CCSID UNICODE
  VERSION V1
  ISOLATION LEVEL CS
  LANGUAGE SQL
  BEGIN
    SET VAR2 = '你好';
    SET VAR3 = VAR1;
  END
</code></pre></div></div>

<p>Setting this input returns the following output:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>VAR1  IN: HELLOWORLD
VAR2 OUT: 你好
VAR3 OUT: HELLOWORLD
</code></pre></div></div>

<h2 id="working-with-user-defined-types-distinct">Working with user-defined types: Distinct</h2>

<p>You can create and use a custom data type that’s called a <a href="https://www.ibm.com/support/knowledgecenter/en/SSEPEK_13.0.0/sqlref/src/tpc/db2z_distincttypessql.html">user-defined distinct type</a> in Db2 for z/OS. For example, let’s say that you keep email documents that are sent to your company in a Db2 table. The Db2 data type of an email document is a CLOB, but you define it as a distinct type so that you can control the types of operations that are performed on the email data. The distinct type is defined like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CREATE DISTINCT TYPE E_MAIL AS CLOB(5M); 
</code></pre></div></div>

<p>Now you can define and write a native stored procedure or user-defined function to search for and return the following information about an email document:</p>

<ul>
  <li>Subject</li>
  <li>Sender</li>
  <li>Date sent</li>
  <li>Message content</li>
  <li>Indicator of whether the document contains a user-specified string.</li>
</ul>

<p>The following example shows how to create a user-defined distinct type for a currency (US_DOLLAR), how to include it in a stored procedure, and how to do some calculations.</p>

<p>Note that the US_DOLLAR distinct type does not automatically inherit the functions and operators of its source type, DECIMAL. You can use <strong>casting</strong> functions to assign values other than host variables. Also, the DISTINCT keyword is optional.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CREATE DISTINCT TYPE US_DOLLAR AS DECIMAL(9,2);
CREATE TYPE EURO AS DECIMAL(9,2);
 
CREATE PROCEDURE ADMF001.SALESSUM (
   IN DOLLAR_AMOUNT US_DOLLAR,
   IN EURO_AMOUNT EURO,
   OUT TOTAL_DOLLAR US_DOLLAR,
   OUT TOTAL_EURO EURO
  )
  LANGUAGE SQL
  VERSION V1
  ISOLATION LEVEL CS 
  BEGIN
    SET TOTAL_DOLLAR = DECIMAL(DOLLAR_AMOUNT)*200;
    SET TOTAL_EURO = DECIMAL(EURO_AMOUNT)+300.07;
  END
</code></pre></div></div>

<p>Setting this input returns the following output:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DOLLAR_AMOUNT  IN: 34.50
EURO_AMOUNT    IN: 500
TOTAL_DOLLAR  OUT: 6900.00
TOTAL_DOLLAR  OUT: 30507.00
</code></pre></div></div>

<h2 id="working-with-user-defined-types-arrays">Working with user-defined types: Arrays</h2>

<p>An array value is a structure that contains an ordered collection of elements. Arrays make it easier to exchange long lists of values with the Db2 server. You can create a user-defined data type for an array in Db2 for z/OS.</p>

<p>The following example shows how to create an ordinary array user-defined type (PHONENUMBERS) that can contain a maximum of 50 elements. The elements are of the DECIMAL(10,0) data type. The array index starts with 1.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CREATE TYPE PHONENUMBERS AS DECIMAL(10,0) ARRAY[50];

CREATE PROCEDURE ADMF001.TESTPROC(
   IN PHONENUMBER PHONENUMBERS,
   OUT outPHONENUMBER PHONENUMBERS
  )
  LANGUAGE SQL
  VERSION V1
  ISOLATION LEVEL CS
  BEGIN
    SET outPHONENUMBER[1]= PHONENUMBER[1];
  END
</code></pre></div></div>

<p>Setting this input returns the following output:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PHONENUMBER      IN: [6262158888;4056789999]
outPHONENUMBER  OUT: [6262158888]
</code></pre></div></div>

<p>The following example shows how to create an ordinary arrays user-defined type for time and timestamp with time zone. The default TIMESTAMP WITH TIME ZONE length is 6.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CREATE TYPE TIMEARRAY AS TIME ARRAY[];
CREATE TYPE TIMESTAMPARRAY AS TIMESTAMP WITH TIME ZONE ARRAY[];

CREATE PROCEDURE ADMF001.TESTPROC (
  IN inTIME TIMEARRAY,
  IN inTIMESTAMPWITHZONE TIMESTAMPARRAY
  OUT outTIME TIME
  OUT outTIMESTAPWITHZONE TIMESTAMPARRAY
    )
  LANGUAGE SQL
  VERSION V1
  ISOLATION LEVEL CS
  BEGIN
    SET outTIME = INTIME[1];
    SET outTIMESTAMPWITHZONE[1] = inTIMESTAMPWITHZONE[1];
  END
</code></pre></div></div>

<p>Setting this input returns the following output:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>inTIME               IN: [08:09:01;10:15:00;11:08:30]
inTIMESTAMPWITHZONE  IN: [2020-10-15 15:01:01.111213141516+4:00]
outTIME             OUT: 08:09:01
outTIMESTAPWITHZONE OUT: [2020-10-15 15:01:01.111213]
</code></pre></div></div>
